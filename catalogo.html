<!-- ========================================= -->
<!-- √ÅREA DO PROPRIET√ÅRIO - SISTEMA COMPLETO -->
<!-- ========================================= -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
// CONFIGURA√á√ÉO DO SUPABASE
const supabaseUrl = 'https://vbcwtypnrkomwmpuwahl.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiY3d0eXBucmtvbXdtcHV3YWhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyODI4MzQsImV4cCI6MjA3OTg1ODgzNH0.nZWx_f-ezPSawD0HIImtoA3fW4cPpPk5BUwfV5nOXkw'
const supabase = supabase.createClient(supabaseUrl, supabaseKey)

// SISTEMA DE SESS√ÉO PARA VISITAS
function gerarSessionId() {
    let sessionId = sessionStorage.getItem('session_id')
    if (!sessionId) {
        sessionId = 'sessao_' + Math.random().toString(36).substring(2) + Date.now().toString(36)
        sessionStorage.setItem('session_id', sessionId)
    }
    return sessionId
}

// REGISTRAR VISITA
async function registrarVisita() {
    try {
        const sessionId = gerarSessionId()
        await supabase.from('visitas').insert([{
            session_id: sessionId,
            pagina: window.location.href,
            user_agent: navigator.userAgent
        }])
    } catch (e) {
        console.log('Erro ao registrar visita:', e)
    }
}

// REGISTRAR VISUALIZA√á√ÉO DE MOTO
async function verMoto(motoId, modelo, marca) {
    try {
        const sessionId = gerarSessionId()
        await supabase.from('visualizacoes_motos').insert([{
            session_id: sessionId,
            moto_id: motoId,
            modelo: modelo,
            marca: marca
        }])
        console.log('Moto registrada:', modelo)
    } catch (e) {
        console.log('Erro ao registrar moto:', e)
    }
}

// =========================================
// SISTEMA DA √ÅREA DO PROPRIET√ÅRIO
// =========================================

// SENHA DO PROPRIET√ÅRIO (voc√™ pode mudar)
const SENHA_PROPRIETARIO = 'admin123'

// FUN√á√ïES PRINCIPAIS
async function adicionarMoto(modelo, marca, ano, preco) {
    const { data, error } = await supabase
        .from('motos')
        .insert([{ modelo, marca, ano, preco: parseFloat(preco) }])
    return { data, error }
}

async function listarMotos() {
    const { data, error } = await supabase
        .from('motos')
        .select('*')
        .order('created_at', { ascending: false })
    return { data, error }
}

async function editarMoto(id, modelo, marca, ano, preco) {
    const { data, error } = await supabase
        .from('motos')
        .update({ modelo, marca, ano, preco: parseFloat(preco) })
        .eq('id', id)
    return { data, error }
}

async function apagarMoto(id) {
    const { data, error } = await supabase
        .from('motos')
        .delete()
        .eq('id', id)
    return { data, error }
}

// FUN√á√ïES DE ANALYTICS
async function getEstatisticas() {
    // Visitantes √∫ltimos 30 dias
    const { data: visitas30dias } = await supabase
        .from('visitas')
        .select('session_id')
        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())

    // Motos mais vistas
    const { data: motosMaisVistas } = await supabase
        .from('visualizacoes_motos')
        .select('modelo, marca')
        .gte('data_visualizacao', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())

    return {
        visitantes30dias: new Set(visitas30dias?.map(v => v.session_id)).size,
        totalVisualizacoes: motosMaisVistas?.length || 0,
        motosMaisVistas: motosMaisVistas?.reduce((acc, item) => {
            const key = `${item.modelo} - ${item.marca}`
            acc[key] = (acc[key] || 0) + 1
            return acc
        }, {}) || {}
    }
}

// =========================================
// INTERFACE DA √ÅREA DO PROPRIET√ÅRIO
// =========================================

function criarAreaProprietario() {
    // Bot√£o flutuante
    const botaoAdmin = document.createElement('button')
    botaoAdmin.innerHTML = 'üîß Admin'
    botaoAdmin.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: #E4BB13;
        color: #0d1b3d;
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 14px;
    `
    
    // Modal de login
    const modalLogin = document.createElement('div')
    modalLogin.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10001;
    `
    
    modalLogin.innerHTML = `
        <div style="background: #1e3a8a; padding: 30px; border-radius: 10px; text-align: center; color: white; max-width: 300px; width: 90%;">
            <h3 style="margin-bottom: 20px; color: #E4BB13;">√Årea do Propriet√°rio</h3>
            <input type="password" id="senhaAdmin" placeholder="Digite a senha" style="width: 100%; padding: 10px; margin-bottom: 15px; border: none; border-radius: 5px;">
            <button id="btnEntrar" style="background: #E4BB13; color: #0d1b3d; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%;">Entrar</button>
            <p id="erroLogin" style="color: #ff4444; margin-top: 10px; display: none;">Senha incorreta!</p>
        </div>
    `
    
    // Painel administrativo
    const painelAdmin = document.createElement('div')
    painelAdmin.style.cssText = `
        position: fixed;
        top: 120px;
        right: 20px;
        background: #1e3a8a;
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 10000;
        max-width: 400px;
        width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        display: none;
        box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        border: 2px solid #E4BB13;
    `
    
    document.body.appendChild(botaoAdmin)
    document.body.appendChild(modalLogin)
    document.body.appendChild(painelAdmin)
    
    // Event Listeners
    botaoAdmin.addEventListener('click', () => {
        modalLogin.style.display = 'flex'
    })
    
    document.getElementById('btnEntrar')?.addEventListener('click', verificarSenha)
    
    function verificarSenha() {
        const senha = document.getElementById('senhaAdmin').value
        const erro = document.getElementById('erroLogin')
        
        if (senha === SENHA_PROPRIETARIO) {
            modalLogin.style.display = 'none'
            abrirPainelAdmin()
        } else {
            erro.style.display = 'block'
        }
    }
    
    async function abrirPainelAdmin() {
        const estatisticas = await getEstatisticas()
        const { data: motos } = await listarMotos()
        
        painelAdmin.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #E4BB13; margin-bottom: 15px;">üèçÔ∏è Painel do Propriet√°rio</h3>
                
                <div style="background: #0d1b3d; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #E4BB13; margin-bottom: 10px;">üìä Estat√≠sticas (30 dias)</h4>
                    <p>üë• Visitantes: ${estatisticas.visitantes30dias}</p>
                    <p>üëÄ Visualiza√ß√µes: ${estatisticas.totalVisualizacoes}</p>
                </div>
                
                <div style="background: #0d1b3d; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #E4BB13; margin-bottom: 10px;">üöÄ A√ß√µes R√°pidas</h4>
                    <button id="btnNovaMoto" style="background: #E4BB13; color: #0d1b3d; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px; width: 100%;">‚ûï Nova Moto</button>
                    <button id="btnAtualizarLista" style="background: #E4BB13; color: #0d1b3d; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px; width: 100%;">üîÑ Atualizar Lista</button>
                </div>
                
                <div style="background: #0d1b3d; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #E4BB13; margin-bottom: 10px;">üìà Motos Mais Vistas</h4>
                    ${Object.entries(estatisticas.motosMaisVistas)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([moto, visualizacoes]) => 
                            `<p style="margin: 5px 0; font-size: 12px;">${moto}: ${visualizacoes} visualiza√ß√µes</p>`
                        ).join('')}
                </div>
                
                <div style="margin-top: 15px;">
                    <h4 style="color: #E4BB13; margin-bottom: 10px;">üèçÔ∏è Motos Cadastradas</h4>
                    <div id="listaMotos" style="max-height: 200px; overflow-y: auto;">
                        ${motos?.map(moto => `
                            <div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 12px;">
                                <strong>${moto.modelo} - ${moto.marca}</strong>
                                <br>R$ ${moto.preco}
                                <div style="margin-top: 5px;">
                                    <button onclick="editarMotoUI('${moto.id}')" style="background: #E4BB13; color: #0d1b3d; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; margin-right: 5px; font-size: 10px;">Editar</button>
                                    <button onclick="apagarMotoUI('${moto.id}')" style="background: #ff4444; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">Apagar</button>
                                </div>
                            </div>
                        `).join('') || '<p>Nenhuma moto cadastrada</p>'}
                    </div>
                </div>
                
                <button id="btnFecharPainel" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%;">‚ùå Fechar</button>
            </div>
        `
        
        painelAdmin.style.display = 'block'
        
        // Event Listeners do painel
        document.getElementById('btnNovaMoto').addEventListener('click', mostrarFormNovaMoto)
        document.getElementById('btnAtualizarLista').addEventListener('click', abrirPainelAdmin)
        document.getElementById('btnFecharPainel').addEventListener('click', () => {
            painelAdmin.style.display = 'none'
        })
    }
    
    function mostrarFormNovaMoto() {
        painelAdmin.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #E4BB13; margin-bottom: 15px;">‚ûï Nova Moto</h3>
                <input type="text" id="novoModelo" placeholder="Modelo (ex: R13)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 5px;">
                <input type="text" id="novaMarca" placeholder="Marca (ex: Honda)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 5px;">
                <input type="number" id="novoAno" placeholder="Ano (ex: 2024)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 5px;">
                <input type="number" id="novoPreco" placeholder="Pre√ßo (ex: 11000)" style="width: 100%; padding: 8px; margin-bottom: 15px; border: none; border-radius: 5px;">
                
                <button id="btnSalvarMoto" style="background: #E4BB13; color: #0d1b3d; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; font-weight: bold;">üíæ Salvar Moto</button>
                <button id="btnCancelar" style="background: #666; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%;">‚Ü©Ô∏è Voltar</button>
            </div>
        `
        
        document.getElementById('btnSalvarMoto').addEventListener('click', salvarNovaMoto)
        document.getElementById('btnCancelar').addEventListener('click', abrirPainelAdmin)
    }
    
    async function salvarNovaMoto() {
        const modelo = document.getElementById('novoModelo').value
        const marca = document.getElementById('novaMarca').value
        const ano = document.getElementById('novoAno').value
        const preco = document.getElementById('novoPreco').value
        
        if (!modelo || !marca || !ano || !preco) {
            alert('Preencha todos os campos!')
            return
        }
        
        const { error } = await adicionarMoto(modelo, marca, parseInt(ano), parseFloat(preco))
        
        if (error) {
            alert('Erro ao salvar: ' + error.message)
        } else {
            alert('Moto salva com sucesso!')
            abrirPainelAdmin()
        }
    }
}

// Fun√ß√µes globais para os bot√µes de editar/apagar
window.editarMotoUI = async function(id) {
    const novaMarca = prompt('Nova marca:')
    const novoModelo = prompt('Novo modelo:')
    const novoAno = prompt('Novo ano:')
    const novoPreco = prompt('Novo pre√ßo:')
    
    if (novaMarca && novoModelo && novoAno && novoPreco) {
        const { error } = await editarMoto(id, novoModelo, novaMarca, parseInt(novoAno), parseFloat(novoPreco))
        if (error) {
            alert('Erro ao editar: ' + error.message)
        } else {
            alert('Moto editada com sucesso!')
            document.querySelector('#btnAtualizarLista')?.click()
        }
    }
}

window.apagarMotoUI = async function(id) {
    if (confirm('Tem certeza que deseja apagar esta moto?')) {
        const { error } = await apagarMoto(id)
        if (error) {
            alert('Erro ao apagar: ' + error.message)
        } else {
            alert('Moto apagada com sucesso!')
            document.querySelector('#btnAtualizarLista')?.click()
        }
    }
}

// =========================================
// INICIALIZAR SISTEMA
// =========================================

document.addEventListener('DOMContentLoaded', function() {
    // Registrar visita
    registrarVisita()
    
    // Criar √°rea do propriet√°rio
    criarAreaProprietario()
    
    // Adicionar tracking nos bot√µes de ver detalhes
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const product = this.getAttribute('data-product')
            const motoNome = this.closest('.scooter-model').querySelector('.model-name').textContent
            verMoto(product, motoNome, 'EloBike')
        })
    })
    
    // Adicionar tracking nos bot√µes do WhatsApp
    document.querySelectorAll('.whatsapp-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productPage = this.closest('.product-page')
            if (productPage) {
                const motoNome = productPage.querySelector('.product-title').textContent
                verMoto('whatsapp_' + Date.now(), motoNome, 'EloBike')
            }
        })
    })
})
</script>

<style>
/* Estilos para a √°rea do propriet√°rio */
#adminPanel input, #adminPanel button {
    font-size: 14px;
}

#adminPanel {
    font-family: 'Inter', sans-serif;
}

/* Responsividade */
@media (max-width: 768px) {
    button[style*="top: 80px; right: 20px;"] {
        top: 60px !important;
        right: 10px !important;
        padding: 8px 12px !important;
        font-size: 12px !important;
    }
    
    div[style*="top: 120px; right: 20px;"] {
        top: 100px !important;
        right: 10px !important;
        max-width: 95vw !important;
    }
}
</style>
